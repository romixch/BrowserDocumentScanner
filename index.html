<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Document detection</title>
  <meta name="viewport" content="initial-scale=1.0, width=device-width" />
</head>

<body>
  <h2>Document detection</h2>
  <p id="status">OpenCV.js is loading...</p>
  <div>
    <video style="width: 90vw" id="video" playsinline autoplay></video><br />
    <span id="video-size"></span>
    <canvas style="display:none" id="canvas"></canvas>
  </div>
  <div>
    <canvas style="width: 90vw" id="canvasOutput"></canvas>
  </div>
  <div>
    <canvas style="width: 90vw" id="transformedOutput"></canvas>
  </div>
  <script type="text/javascript">
    const constraints = {
      audio: false,
      video: {
        facingMode: "environment",
        width: {min: 720}, 
        height: {min: 720}
      }
    };

    let videoOn = false;
    let opencvReady = false;
    let conversionOn = false;

    async function captureVideo() {
      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      window.stream = stream;
      const video = document.getElementById('video');
      video.srcObject = stream;
      const videoSettings = stream.getVideoTracks()[0].getSettings();
      document.getElementById('video-size').innerText = videoSettings.width + ' x ' + videoSettings.height;
      const canvas = document.getElementById('canvas');
      canvas.height = videoSettings.height;
      canvas.width = videoSettings.width;

      videoOn = true;
    }
    function convertCapturedImage() {
      const canvas = document.getElementById('canvas');
      var context = canvas.getContext('2d');
      const video = document.getElementById('video');
      context.drawImage(video, 0, 0);
      window.documentCoords = processImage(canvas);
    }
    document.getElementById("video").addEventListener('click', () => {
      conversionOn = !conversionOn;
    });
    captureVideo();

    function onOpenCvReady() {
      opencvReady = true;
      document.getElementById('status').innerHTML = 'OpenCV.js is ready.';
    }

    setInterval(() => {
      console.log('interval', videoOn, opencvReady);
      if (videoOn && opencvReady && conversionOn) {
        convertCapturedImage();
      }
    }, 2000);

    document.getElementById("canvasOutput").addEventListener('click', () => {
      const canvas = document.getElementById('canvas');
      const src = cv.imread(canvas);
      cutOutDocument(src, window.documentCoords);
      conversionOn = false;
      videoOn = false;
    });

  </script>
  <script async src="opencv.js" onload="onOpenCvReady();" type="text/javascript"></script>
  <script async src="document-detection.js" type="text/javascript"></script>
</body>

</html>