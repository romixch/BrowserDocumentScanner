<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Document detection</title>
  <meta name="viewport" content="initial-scale=1.0, width=device-width" />
</head>

<body>
  <h2>Document detection</h2>
  <p id="status">OpenCV.js is loading...</p>
  <div>
    <video style="max-width: 90vw" id="video" playsinline autoplay></video><br />
    <button id="toggleProcessing">toggle processing</button><br />
    <canvas style="display:none" id="canvas" width="1280" height="720"></canvas>
  </div>
  <div>
    <canvas id="canvasOutput" style="max-width: 90vw;"></canvas>
  </div>
  <div>
    <canvas id="transformedOutput" style="max-width: 90vw;"></canvas>
  </div>
  <script type="text/javascript">
    const constraints = {
      audio: false,
      video: {
        facingMode: "environment",
        width: 1280, height: 720
      }
    };

    let videoOn = false;
    let opencvReady = false;
    let conversionOn = false;

    async function captureVideo() {
      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      window.stream = stream;
      const video = document.getElementById('video');
      video.srcObject = stream;
      videoOn = true;
    }
    function convertCapturedImage() {
      const canvas = document.getElementById('canvas');
      var context = canvas.getContext('2d');
      const video = document.getElementById('video');
      context.drawImage(video, 0, 0, 1280, 720);
      window.documentCoords = processImage(canvas);
    }
    const toggleProcessing = document.getElementById("toggleProcessing");
    toggleProcessing.addEventListener('click', () => {
      conversionOn = !conversionOn;
    });
    captureVideo();

    function onOpenCvReady() {
      opencvReady = true;
      document.getElementById('status').innerHTML = 'OpenCV.js is ready.';
    }

    setInterval(() => {
      console.log('interval', videoOn, opencvReady);
      if (videoOn && opencvReady && conversionOn) {
        convertCapturedImage();
      }
    }, 1000);

    document.getElementById("canvasOutput").addEventListener('click', () => {
      const canvas = document.getElementById('canvas');
      const src = cv.imread(canvas);
      cutOutDocument(src, window.documentCoords);
    });

  </script>
  <script async src="opencv.js" onload="onOpenCvReady();" type="text/javascript"></script>
  <script async src="document-detection.js" type="text/javascript"></script>
</body>

</html>